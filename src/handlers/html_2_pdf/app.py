import base64
import json
import xml.etree.ElementTree as ET

import requests
from jinja2 import Template
from weasyprint import HTML

TEMPLATE_STR = '<!DOCTYPE html>\n<html lang="es">\n<head>\n    <meta charset="UTF-8">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <link rel="preconnect" href="https://fonts.googleapis.com">\n    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>\n    <link href="https://fonts.googleapis.com/css2?family=Carlito:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">\n    <title>Formato Syllabus</title>\n    <style>\n        @page {\n            margin: 0.3in 0.3in;\n            size: Letter;\n        }\n\n        * {\n            box-sizing: border-box;\n            font-family: "Carlito", sans-serif;\n            text-align: justify;\n            text-justify: inter-word;\n            margin: 0;\n            padding: 0;\n        }\n\n        table, th, td {\n            border: 2px solid black;\n            word-wrap: break-word;\n            font-size: 12px;\n            padding: 1px 3px;\n        }\n        \n        table {\n            width: 100%;\n            border-collapse: collapse;\n            border: 0;\n            border-spacing: 0;\n            text-align: left;\n            table-layout: fixed;\n            margin-top: 10px;\n            margin-bottom: 10px;\n        }\n\n        .bold {\n            font-weight: bold;\n        }\n\n        .center-image {\n            display: block;\n            margin-left: auto;\n            margin-right: auto;\n            width: 100px;\n        }\n\n        .container {\n            width: 100%;\n            max-width: 21cm;\n            margin: 0 auto;\n        }\n\n        .table-header {\n            background-color: #c9c9c9;\n            /*#d3d3d3*/\n        }\n\n        .text-center {\n            text-align: center !important;\n        }\n\n        .text-justify {\n            text-align: justify !important;\n        }\n\n        .text-padding {\n            padding-top: 5px;\n            padding-bottom: 5px;\n        }\n\n        .text-left {\n            text-align: left !important;\n        }\n\n        .version-doc {\n            font-size: 12px;\n        }\n    </style>\n</head>\n<body>\n    <div class="container">\n        <table>\n            <tr>\n                <td colspan="2">\n                    <div>\n                        <img src="https://raw.githubusercontent.com/udistrital/prueba_piloto_funciones_lambda/develop/img/escudo_linea_negro.png" \n                        alt="Escudo UD"\n                        class="center-image"\n                        width="10px">\n                    </div>\n                </td>\n                <td class="bold text-center" colspan="7">\n                    <p class="bold text-center">\n                        UNIVERSIDAD DISTRITAL <br>\n                        FRANCISCO JOSÉ DE CALDAS\n                    </p>\n                    <br>\n                    <p class="bold text-center">\n                        SYLLABUS\n                    </p>\n                </td>\n            </tr>\n            <tr>\n                <td class="bold" colspan="2">\n                    <p>FACULTAD:</p>\n                </td>\n                <td colspan="7">\n                    {{ nombre_facultad }}\n                </td>\n            </tr>\n            <tr>\n                <td class="bold" colspan="2">\n                    <p>PROYECTO CURRICULAR:</p>\n                </td>\n                <td colspan="4">\n                    {{ nombre_proyecto_curricular }}\n                </td>\n                <td class="bold text-center" colspan="2">\n                    <p class="text-center">CÓDIGO PLAN DE ESTUDIOS:</p>\n                </td>\n                <td class="text-center" colspan="1">\n                    <p class="text-center">\n                        {{ cod_plan_estudio }}\n                    </p>\n                </td>\n            </tr>\n            <tr>\n                <td class="bold text-center" colspan="9">\n                    <p class="text-center">I. IDENTIFICACIÓN DEL ESPACIO ACADÉMICO</p>\n                </td>\n            </tr>\n            <tr>\n                <td class="bold table-header" colspan="9">\n                    <p>\n                        NOMBRE DEL ESPACIO ACADÉMICO: {{ nombre_espacio_academico }}\n                    </p>\n                </td>\n            </tr>\n            <tr>\n                <td colspan="3">\n                    <p>\n                        Código del espacio académico: \n                    </p>\n                </td>\n                <td class="text-center" colspan="1">\n                    <p class="text-center">\n                        {{ cod_espacio_academico }}\n                    </p>\n                </td>\n                <td colspan="3">\n                    <p>\n                        Número de créditos académicos: \n                    </p>\n                </td>\n                <td colspan="2">\n                    <p class="text-center">\n                        {{ num_creditos }}\n                    </p>\n                </td>\n            </tr>\n            <tr>\n                <td colspan="3">\n                    <p>\n                        Distribución horas de trabajo:\n                    </p>\n                </td>\n                <td class="text-center" colspan="1">\n                    <p class="text-center">\n                        HTD\n                    </p>\n                </td>\n                <td class="text-center" colspan="1">\n                    <p class="text-center">\n                        {{ htd }}\n                    </p>\n                </td>\n                <td class="text-center" colspan="1">\n                    <p class="text-center">\n                        HTC\n                    </p>\n                </td>\n                <td class="text-center" colspan="1">\n                    <p class="text-center">\n                        {{ htc }}\n                    </p>\n                </td>\n                <td class="text-center" colspan="1">\n                    <p class="text-center">\n                        HTA\n                    </p>\n                </td>\n                <td colspan="1">\n                    <p class="text-center">\n                        {{ hta }}\n                    </p>\n                </td>\n            </tr>\n            <tr>\n                <td colspan="3">\n                    <p>\n                        Tipo de espacio académico (X):\n                    </p>\n                </td>\n                <td class="text-center" colspan="1">\n                    <p class="text-center">\n                        Asignatura\n                    </p>\n                </td>\n                <td class="text-center" colspan="1">\n                    {% if es_asignatura %}\n                    <p class="text-center">\n                        X\n                    </p>\n                    {% endif %}\n                </td>\n                <td class="text-center" colspan="1">\n                    <p class="text-center">\n                        Cátedra\n                    </p>\n                </td>\n                <td class="text-center" colspan="1">\n                    {% if es_catedra %}\n                    <p class="text-center">\n                        X\n                    </p>\n                    {% endif %}\n                </td>\n                <td colspan="1">\n                </td>\n                <td colspan="1">\n                </td>\n            </tr>\n            <tr>\n                <td class="bold table-header text-center" colspan="9">\n                    <p class="text-center">\n                        NATURALEZA DEL ESPACIO ACADÉMICO (X):\n                    </p>\n                </td>\n            </tr>\n            <tr>\n                <td class="text-center" colspan="1">\n                    <p class="text-center">\n                        Obligatorio Básico\n                    </p>\n                </td>\n                <td class="text-center" colspan="1">\n                    {% if es_obligatorio_basico %}\n                    <p class="text-center">\n                        X\n                    </p>\n                    {% endif %}\n                </td>\n                <td class="text-center" colspan="2">\n                    <p class="text-center">\n                        Obligatorio Complementario\n                    </p>\n                </td>\n                <td class="text-center" colspan="1">\n                    {% if es_obligatorio_comp %}\n                    <p class="text-center">\n                        X\n                    </p>\n                    {% endif %}\n                </td>\n                <td class="text-center" colspan="1">\n                    <p class="text-center">\n                        Electivo Intrínseco\n                    </p>\n                </td>\n                <td class="text-center" colspan="1">\n                    {% if es_electivo_int %}\n                    <p class="text-center">\n                        X\n                    </p>\n                    {% endif %}\n                </td>\n                <td class="text-center" colspan="1">\n                    <p class="text-center">\n                        Electivo Extrínseco\n                    </p>\n                </td>\n                <td class="text-center" colspan="1">\n                    {% if es_electivo_ext %}\n                    <p class="text-center">\n                        X\n                    </p>\n                    {% endif %}\n                </td>\n            </tr>\n            <tr>\n                <td class="bold table-header text-center" colspan="9">\n                    <p class="text-center">\n                        CARÁCTER DEL ESPACIO ACADÉMICO (X):\n                    </p>\n                </td>\n            </tr>\n            <tr>\n                <td class="text-center" colspan="1">\n                    <p class="text-center">\n                        Teórico\n                    </p>\n                </td>\n                <td class="text-center" colspan="1">\n                    {% if es_teorico %}\n                    <p class="text-center">\n                        X\n                    </p>\n                    {% endif %}\n                </td>\n                <td class="text-center" colspan="1">\n                    <p class="text-center">\n                        Práctico\n                    </p>\n                </td>\n                <td class="text-center" colspan="1">\n                    {% if es_practico %}\n                    <p class="text-center">\n                        X\n                    </p>\n                    {% endif %}\n                </td>\n                <td class="text-center" colspan="1">\n                    <p class="text-center">\n                        Teórico-Práctico\n                    </p>\n                </td>\n                <td class="text-center" colspan="1">\n                    {% if es_teorico_practico %}\n                    <p class="text-center">\n                        X\n                    </p>\n                    {% endif %}\n                </td>\n                <td colspan="1">\n                    <p>\n                        Otros: (abrir desplegable)\n                    </p>\n                </td>\n                <td class="text-center" colspan="1">\n                    {% if otro_caracter_esp_academico %}\n                    <p class="text-center">\n                        X\n                    </p>\n                    {% endif %}\n                </td>\n                <td colspan="1">\n                    {% if cual_otro_caracter %}\n                    <p class="text-justify text-padding">\n                        Cuál: {{ cual_otro_caracter }}\n                    </p>\n                    {% else %}\n                    <p class="text-justify text-padding">\n                        Cuál:_______\n                    </p>\n                    {% endif %}\n                </td>\n            </tr>\n            <tr>\n                <td class="bold table-header text-center" colspan="9">\n                    <p class="text-center">\n                        MODALIDAD DE OFERTA DEL ESPACIO ACADÉMICO (X):\n                    </p>\n                </td>\n            </tr>\n            <tr>\n                <td class="text-center" colspan="1">\n                    <p class="text-center">\n                        Presencial\n                    </p>\n                </td>\n                <td class="text-center" colspan="1">\n                    {% if es_presencial %}\n                    <p class="text-center">\n                        X\n                    </p>\n                    {% endif %}\n                </td>\n                <td class="text-center" colspan="1">\n                    <p class="text-center">\n                        Presencial con incorporación de TIC\n                    </p>\n                </td>\n                <td class="text-center" colspan="1">\n                    {% if es_presencial_tic %}\n                    <p class="text-center">\n                        X\n                    </p>\n                    {% endif %}\n                </td>\n                <td class="text-center" colspan="1">\n                    <p class="text-center">\n                        Virtual\n                    </p>\n                </td>\n                <td class="text-center" colspan="1">\n                    {% if es_virtual %}\n                    <p class="text-center">\n                        X\n                    </p>\n                    {% endif %}\n                </td>\n                <td colspan="1">\n                    <p>\n                        Otros:\n                    </p>\n                </td>\n                <td class="text-center" colspan="1">\n                    {% if otra_modalidad %}\n                    <p class="text-center">\n                        X\n                    </p>\n                    {% endif %}\n                </td>\n                <td colspan="1">\n                    {% if cual_otra_modalidad %}\n                    <p class="text-justify text-padding">\n                        Cuál: {{ cual_otra_modalidad }}\n                    </p>\n                    {% else %}\n                    <p class="text-justify text-padding">\n                        Cuál:_______\n                    </p>\n                    {% endif %}\n                </td>\n            </tr>\n            <tr>\n                <td class="bold table-header text-center" colspan="9">\n                    <p class="text-center">\n                        II. SUGERENCIAS DE SABERES Y CONOCIMIENTOS PREVIOS\n                    </p>\n                </td>\n            </tr>\n            <tr>\n                <td class="text-justify" colspan="9">\n                    <p class="text-justify text-padding">\n                        {{ sugerencias }}\n                    </p>\n                </td>\n            </tr>\n            <tr>\n                <td class="bold table-header text-center" colspan="9">\n                    <p class="text-center">\n                        III. JUSTIFICACIÓN DEL ESPACIO ACADÉMICO\n                    </p>\n                </td>\n            </tr>\n            <tr>\n                <td class="text-justify" colspan="9">\n                    <p class="text-justify text-padding">\n                        {{ justificacion }}\n                    </p>\n                </td>\n            </tr>\n            <tr>\n                <td class="bold table-header text-center" colspan="9">\n                    <p class="text-center">\n                        IV. OBJETIVOS DEL ESPACIO ACADÉMICO (GENERAL Y ESPECÍFICOS)\n                    </p>\n                </td>\n            </tr>\n            <tr>\n                <td class="text-justify" colspan="9">\n                    <p class="text-justify text-padding">\n                        {{ objetivo_general }}\n                        <br> <br>\n                        {{ objetivos_especificos }}\n                    </p>\n                </td>\n            </tr>\n            <tr>\n                <td class="bold table-header text-center" colspan="9">\n                    <p class="text-center">\n                        V. PROPÓSITOS DE FORMACIÓN Y DE APRENDIZAJE (PFA) DEL ESPACIO ACADEMICO \n                    </p>\n                </td>\n            </tr>\n            <tr>\n                <td class="text-justify" colspan="9">\n                    {% if propositos is iterable and (propositos is not string and propositos is not mapping) %}\n                    <table>\n                        <thead>\n                            <tr>\n                                <th class="text-center">#</th>\n                                <th class="text-center">PFA del programa / proyecto</th>\n                                <th class="text-center">PFA de la asignatura</th>\n                                <th class="text-center">Competencias</th>\n                            </tr>\n                        </thead>\n                        <tbody>\n                            {% for proposito in propositos %}\n                            <tr>\n                                <td class="text-center"> {{ loop.index }} </td>\n                                <td class="text-justify"> {{ proposito.pfa_programa }} </td>\n                                <td class="text-justify"> {{ proposito.pfa_asignatura }} </td>\n                                <td class="text-justify"> {{ proposito.competencias }} </td>\n                            </tr>\n                            {% endfor %}\n                        </tbody>\n                    </table>\n                    {% else %}\n                    <p class="text-justify text-padding">\n                        {{ propositos }}\n                    </p>\n                    {% endif %}\n                    \n                </td>\n            </tr>\n            <tr>\n                <td class="bold table-header text-center" colspan="9">\n                    <p class="text-center">\n                        VI. CONTENIDOS TEMÁTICOS\n                    </p>\n                </td>\n            </tr>\n            <tr>\n                <td class="text-justify" colspan="9">\n                    <p class="text-justify text-padding">\n                        {{ contenido_tematico }}\n                    </p>\n                </td>\n            </tr>\n            <tr>\n                <td class="bold table-header text-center" colspan="9">\n                    <p class="text-center">\n                        VII. ESTRATEGIAS DE ENSEÑANZA QUE FAVORECEN EL APRENDIZAJE\n                    </p>\n                </td>\n            </tr>\n            <tr>\n                <td class="text-justify" colspan="9">\n                    <p class="text-justify text-padding">\n                        {{ estrategias_ensenanza }}\n                    </p>\n                </td>\n            </tr>\n            <tr>\n                <td class="bold table-header text-center" colspan="9">\n                    <p class="text-center">\n                        VIII. EVALUACIÓN\n                    </p>\n                </td>\n            </tr>\n            <tr>\n                <td class="text-justify" colspan="9">\n                    <p class="text-justify text-padding">\n                        {{ evaluacion }}\n                    </p>\n                </td>\n            </tr>\n            <tr>\n                <td class="bold table-header text-center" colspan="9">\n                    <p class="text-center">\n                        IX. MEDIOS Y RECURSOS EDUCATIVOS\n                    </p>\n                </td>\n            </tr>\n            <tr>\n                <td class="text-justify" colspan="9">\n                    <p class="text-justify text-padding">\n                        {{ medios_recursos }}\n                    </p>\n                </td>\n            </tr>\n            <tr>\n                <td class="bold table-header text-center" colspan="9">\n                    <p class="text-center">\n                        X. PRÁCTICAS ACADÉMICAS - SALIDAS DE CAMPO\n                    </p>\n                </td>\n            </tr>\n            <tr>\n                <td class="text-justify" colspan="9">\n                    <p class="text-justify text-padding">\n                        {{ practicas_salidas }}\n                    </p>\n                </td>\n            </tr>\n            <tr>\n                <td class="bold table-header text-center" colspan="9">\n                    <p class="text-center">\n                        XI. BIBLIOGRAFÍA\n                    </p>\n                </td>\n            </tr>\n            <tr>\n                <td class="text-justify" colspan="9">\n                    <p class="text-justify text-padding">\n                        Básicas <br>\n                        {{ bibliografia_basica }}\n                    </p>\n                    <p class="text-justify text-padding">\n                        Complementarias <br>\n                        {{ bibliografia_complementaria }}\n                    </p>\n                    <p class="text-justify text-padding">\n                        Páginas web <br>\n                        {{ bibliografia_paginas }}\n                    </p>\n                </td>\n            </tr>\n            <tr>\n                <td class="bold table-header text-center" colspan="9">\n                    <p class="text-center">\n                        XII. SEGUIMIENTO Y ACTUALIZACIÓN DEL SYLLABUS\n                    </p>\n                </td>\n            </tr>\n            <tr>\n                <td class="text-justify" colspan="3">\n                    <p class="text-justify">\n                        Fecha revisión por Consejo Curricular:\n                    </p>\n                </td>\n                <td class="text-justify" colspan="6">\n                    <p class="text-justify">\n                        {{ fecha_rev_consejo }}\n                    </p>\n                </td>\n            </tr>\n            <tr>\n                <td class="text-justify" colspan="3">\n                    <p class="text-justify">\n                        Fecha aprobación por Consejo Curricular: \n                    </p>\n                </td>\n                <td class="text-justify" colspan="3">\n                    <p class="text-justify">\n                        {{ fecha_aprob_consejo }}\n                    </p>\n                </td>\n                <td class="text-justify" colspan="1">\n                    <p class="text-justify">\n                        Número de acta: \n                    </p>\n                </td>\n                <td class="text-center" colspan="2">\n                    <p class="text-center">\n                        {{ num_acta }}\n                    </p>\n                </td>\n            </tr>\n        </table>\n        <div>\n            <p class="version-doc">\n                Documento versión: 12 julio 2023\n            </p>\n        </div>\n    </div>\n</body>\n</html>'


def get_space_data(pensum_id, carrera_id, asignatura_cod) -> (dict, bool):
    try:
        print("Consultando data requerida")
        url = f"http://busservicios.intranetoas.udistrital.edu.co:8282/wso2eiserver/services/" \
              f"academica_pruebas/detalle_espacio_academico/{pensum_id}/{carrera_id}/{asignatura_cod}"

        response_xml = requests.get(url)
        print("Finalizada la consulta a la fuente")
        response_xml.raise_for_status()

        print("Extrayendo XML")
        tree_xml = ET.fromstring(response_xml.content)
        print("Datos extraidos")

        if len(list(tree_xml)) > 0:
            print("Si tiene espacios")
            data = {}
            for space in list(tree_xml):
                for field_space in list(space):
                    data[str(field_space.tag).split("}")[-1]] = field_space.text
            return data, False
        else:
            print("No tiene espacios")
            return {"error": "Without academic spaces"}, True
    except Exception as ex:
        print("Error consultado datos requeridos")
        print(ex)
        return {"error": str(ex)}, True


def make_pdf(html: str):
    """Generate a PDF file from a string of HTML"""
    print("make_pdf")
    html_doc = HTML(string=html)
    #html_doc.write_pdf("/home/edwargl/Documentos/OAS/out_2.pdf")
    byte_doc = html_doc.write_pdf()
    encoded = base64.b64encode(byte_doc)
    return encoded.decode('utf-8')


def render_html(template_str: str, data: dict):
    template = Template(template_str)
    html_result = template.render(**data)
    return html_result


def format_response(result, message: str, status_code: int, success: bool):
    if isinstance(result, dict):
        if success:
            return {"statusCode": status_code,
                    "body": json.dumps({
                        "Success": success,
                        "Status": status_code,
                        "Message": message,
                        "Data": result
                    })}
        else:
            return {"statusCode": status_code,
                    "body": json.dumps({
                        "Success": success,
                        "Status": status_code,
                        "Message": message
                    })}


def lambda_handler(event, context):
    try:
        print(event)
        # space_data, err = get_space_data(307, 375, 1)
        space_data = {
            "tipo": "asignatura",
            "cea_abr": "ob"
        }
        err = False
        if not err:
            es_asignatura = str(space_data.get("tipo")).lower() == "asignatura"
            plan_data = {
                "nombre_facultad": "",
                "nombre_proyecto_curricular": "",
                "cod_plan_estudio": "",
                "nombre_espacio_academico": space_data.get("asi_nombre", ""),
                "cod_espacio_academico": space_data.get("asi_cod", ""),
                "num_creditos": space_data.get("pen_cre", ""),
                "htd": space_data.get("pen_nro_ht", ""),
                "htc": space_data.get("pen_nro_hp", ""),
                "hta": space_data.get("pen_nro_aut", ""),
                "es_asignatura": es_asignatura,
                "es_catedra": not es_asignatura,
                "es_obligatorio_basico": str(space_data.get("cea_abr")).lower() == "ob",
                "es_obligatorio_comp": str(space_data.get("cea_abr")).lower() == "oc",
                "es_electivo_int": str(space_data.get("cea_abr")).lower() == "ei",
                "es_electivo_ext": str(space_data.get("cea_abr")).lower() == "ee",
                "es_teorico": False,
                "es_practico": False,
                "es_teorico_practico": False,
                "otro_caracter_esp_academico": False,
                "cual_otro_caracter": None,
                "es_presencial": False,
                "es_presencial_tic": False,
                "es_virtual": False,
                "otra_modalidad": False,
                "cual_otra_modalidad": None
            }

            # Render template
            rendered_template = render_html(TEMPLATE_STR, plan_data)
            result_doc_64 = make_pdf(rendered_template)
            return format_response(
                {"document": result_doc_64},
                "Syllabus Template OK",
                200,
                True)
        else:
            return format_response(
                {},
                f"Error get academic space data! Detail: {space_data['error']}",
                500,
                False)
    except Exception as ex:
        print(f"Error in syllabus template lambda. Detail: {ex}")
        return format_response(
            {},
            f"Error in syllabus template lambda! Detail: {ex}",
            500,
            False)
